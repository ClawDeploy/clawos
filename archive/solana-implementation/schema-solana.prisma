generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Agent = AI Agent that uses the platform
model Agent {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  avatar      String?  // IPFS hash or URL
  
  // Owner information
  ownerWallet String   @unique // Solana wallet address
  ownerEmail  String?
  
  // Wallet tracking
  walletAddress    String?  @unique // Agent's receiving wallet (can be same as owner)
  walletVerified   Boolean  @default(false)
  walletVerifiedAt DateTime?
  
  // Earnings tracking
  totalEarnings    Decimal  @default(0) @db.Decimal(10, 6)
  pendingEarnings  Decimal  @default(0) @db.Decimal(10, 6)
  withdrawnEarnings Decimal @default(0) @db.Decimal(10, 6)
  
  // Reputation system
  reputation  Float    @default(0)
  totalSales  Int      @default(0)
  totalPurchases Int  @default(0)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  skills      Skill[]
  purchases   Purchase[]
  reviews     Review[]
  apiKeys     ApiKey[]
  earnings    Earning[]     // Earnings received
  sales       Sale[]        // Sales made (as seller)
  sentTransactions     Transaction[] @relation("SentTransactions")
  receivedTransactions Transaction[] @relation("ReceivedTransactions")
  
  @@map("agents")
}

// Skill = Capability sold on marketplace
model Skill {
  id          String   @id @default(uuid())
  name        String
  version     String   @default("1.0.0")
  description String
  
  // Categorization
  category    SkillCategory
  tags        String[] // Array of tags
  
  // Code repository
  repoUrl     String   // GitHub repository URL
  repoBranch  String   @default("main")
  entryPoint  String   // Main file/function
  documentation String? // IPFS hash
  
  // Pricing
  pricingType PricingType
  price       Decimal  @db.Decimal(10, 6)
  currency    String   @default("USDC")
  
  // Subscription/usage details
  interval    String?  // For subscriptions: daily, weekly, monthly
  unitName    String?  // For usage-based: "call", "1000_calls"
  
  // Blockchain tracking
  skillListingPda String? @unique // Solana PDA for skill listing
  isListedOnChain Boolean @default(false)
  listedAt        DateTime?
  
  // Stats
  rating      Float    @default(0)
  reviewCount Int      @default(0)
  downloadCount Int    @default(0)
  
  // Status
  isPublished Boolean @default(false)
  isVerified  Boolean @default(false)
  
  // Relations
  agentId     String
  agent       Agent    @relation(fields: [agentId], references: [id])
  
  purchases   Purchase[]
  reviews     Review[]
  endpoints   Endpoint[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("skills")
}

// API Endpoints for a skill
model Endpoint {
  id          String   @id @default(uuid())
  skillId     String
  skill       Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)
  
  path        String   // e.g., "/send"
  method      String   // GET, POST, etc.
  description String
  
  // Request/Response schema (JSON)
  requestSchema  String? @db.Text
  responseSchema String? @db.Text
  
  createdAt   DateTime @default(now())
  
  @@map("endpoints")
}

// Purchase record
model Purchase {
  id          String   @id @default(uuid())
  
  // Relations
  buyerId     String
  buyer       Agent    @relation(fields: [buyerId], references: [id])
  skillId     String
  skill       Skill    @relation(fields: [skillId], references: [id])
  
  // License details
  licenseType LicenseType
  
  // Payment
  amount      Decimal  @db.Decimal(10, 6)
  currency    String
  txHash      String   @unique // Solana transaction hash
  
  // Blockchain tracking
  licensePda  String?  @unique // Solana PDA for license account
  escrowPda   String?  // Solana PDA for escrow token account
  
  // Usage tracking
  usageLimit  Int?     // For usage-based
  currentUsage Int     @default(0)
  expiresAt   DateTime? // For subscriptions
  
  // Status
  status      PurchaseStatus @default(ACTIVE)
  
  // Transaction details
  platformFee Decimal  @default(0) @db.Decimal(10, 6)
  sellerAmount Decimal @default(0) @db.Decimal(10, 6)
  
  createdAt   DateTime @default(now())
  
  @@map("purchases")
}

// Earnings record for sellers
model Earning {
  id          String   @id @default(uuid())
  
  // Relations
  agentId     String
  agent       Agent    @relation(fields: [agentId], references: [id])
  
  // Source
  skillId     String?
  purchaseId  String?
  
  // Amount
  amount      Decimal  @db.Decimal(10, 6)
  currency    String   @default("USDC")
  
  // Status
  status      EarningStatus @default(PENDING)
  
  // Withdrawal
  withdrawnAt DateTime?
  withdrawalTxHash String?
  
  // Transaction details
  platformFee Decimal  @default(0) @db.Decimal(10, 6)
  
  createdAt   DateTime @default(now())
  
  @@map("earnings")
}

// Sales record
model Sale {
  id          String   @id @default(uuid())
  
  // Relations
  sellerId    String
  seller      Agent    @relation(fields: [sellerId], references: [id])
  
  // Sale details
  skillId     String
  buyerWallet String   // Buyer's wallet address
  
  // Amount
  amount      Decimal  @db.Decimal(10, 6)
  currency    String   @default("USDC")
  
  // Transaction
  txHash      String   @unique
  
  createdAt   DateTime @default(now())
  
  @@map("sales")
}

// All transactions (deposits, withdrawals, transfers)
model Transaction {
  id          String   @id @default(uuid())
  
  // Transaction type
  type        TransactionType
  
  // Participants
  fromAgentId String?
  fromAgent   Agent?   @relation("SentTransactions", fields: [fromAgentId], references: [id])
  toAgentId   String?
  toAgent     Agent?   @relation("ReceivedTransactions", fields: [toAgentId], references: [id])
  
  // External addresses
  fromAddress String?  // External wallet address
  toAddress   String?  // External wallet address
  
  // Amount
  amount      Decimal  @db.Decimal(10, 6)
  currency    String   @default("USDC")
  
  // Fees
  platformFee Decimal  @default(0) @db.Decimal(10, 6)
  networkFee  Decimal  @default(0) @db.Decimal(10, 6)
  
  // Status
  status      TransactionStatus @default(PENDING)
  
  // Blockchain
  txHash      String?  @unique
  blockNumber Int?
  confirmedAt DateTime?
  
  // Metadata
  description String?
  metadata    Json?    // Additional data
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("transactions")
}

// Wallet connection nonces for verification
model WalletNonce {
  id          String   @id @default(uuid())
  
  walletAddress String @unique
  nonce       String
  expiresAt   DateTime
  
  createdAt   DateTime @default(now())
  
  @@map("wallet_nonces")
}

// Reviews and ratings
model Review {
  id          String   @id @default(uuid())
  
  reviewerId  String
  reviewer    Agent    @relation(fields: [reviewerId], references: [id])
  skillId     String
  skill       Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)
  
  rating      Int      // 1-5 stars
  comment     String?
  
  createdAt   DateTime @default(now())
  
  @@map("reviews")
}

// API Keys for authentication
model ApiKey {
  id          String   @id @default(uuid())
  agentId     String
  agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  keyHash     String   @unique // Hashed API key
  name        String   // e.g., "Production", "Development"
  
  // Rate limiting
  rateLimit   Int      @default(1000) // requests per hour
  
  // Status
  isActive    Boolean  @default(true)
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  
  createdAt   DateTime @default(now())
  
  @@map("api_keys")
}

// Usage logs for billing
model UsageLog {
  id          String   @id @default(uuid())
  
  purchaseId  String
  skillId     String
  agentId     String
  
  endpoint    String
  requestSize Int
  responseSize Int
  duration    Int      // milliseconds
  cost        Decimal  @db.Decimal(10, 6)
  
  timestamp   DateTime @default(now())
  
  @@map("usage_logs")
}

// Enums
enum SkillCategory {
  COMMUNICATION
  AUTOMATION
  ANALYSIS
  CREATIVE
  UTILITY
  INTEGRATION
}

enum PricingType {
  FREE
  ONE_TIME
  SUBSCRIPTION
  USAGE
}

enum LicenseType {
  PERSONAL
  COMMERCIAL
  ENTERPRISE
}

enum PurchaseStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  REFUNDED
  PENDING
  FAILED
}

enum EarningStatus {
  PENDING
  AVAILABLE
  WITHDRAWN
  CANCELLED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  PAYMENT
  REFUND
  PLATFORM_FEE
  EARNING
  TRANSFER
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  FAILED
  CANCELLED
}
